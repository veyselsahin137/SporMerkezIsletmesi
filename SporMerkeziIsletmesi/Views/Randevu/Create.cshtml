@model SporMerkeziIsletmesi.Models.Randevu

@{
    ViewData["Title"] = "Yeni Randevu";
}

<h2 class="mt-4">Yeni Randevu Al</h2>

<form asp-action="Create" method="post" class="mt-3">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <!-- ÜyeId gizli geliyor, ama controller zaten login kullanıcıdan da set ediyor -->
    <input type="hidden" name="UyeId" value="@ViewData["UyeId"]" />

    <div class="card p-4 shadow-sm">

        <div class="mb-3">
            <label asp-for="HizmetId" class="form-label">Hizmet</label>
            <select asp-for="HizmetId"
                    class="form-select"
                    asp-items="ViewBag.HizmetId"
                    id="HizmetId">
                <option value="">Hizmet seçin</option>
            </select>
            <span asp-validation-for="HizmetId" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="AntrenorId" class="form-label">Antrenör</label>
            <select asp-for="AntrenorId"
                    class="form-select"
                    id="AntrenorId">
                <option value="">Önce hizmet seçin</option>
            </select>
            <span asp-validation-for="AntrenorId" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label class="form-label">Tarih</label>
            <input type="date" id="seciliTarih" name="seciliTarih" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Saat</label>
            <select id="seciliSaat" name="seciliSaat" class="form-select">
                <option value="">Önce tarih ve antrenör seçin</option>
            </select>
        </div>

        <button type="submit" class="btn btn-success">Randevu Oluştur</button>
        <a asp-action="Index" class="btn btn-secondary ms-2">Randevularım</a>
    </div>
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        $(document).ready(function () {

            // HİZMETE GÖRE ANTRENÖR LİSTESİ
            $('#HizmetId').change(function () {
                var hizmetId = $(this).val();

                $('#AntrenorId').empty();
                $('#AntrenorId').append($('<option>').val('').text('Yükleniyor...'));
                $('#seciliSaat').empty();
                $('#seciliSaat').append($('<option>').val('').text('Önce tarih ve antrenör seçin'));

                if (hizmetId) {
                    $.getJSON('@Url.Action("GetAntrenorByHizmet", "Randevu")', { hizmetId: hizmetId })
                        .done(function (data) {
                            $('#AntrenorId').empty();
                            $('#AntrenorId').append($('<option>').val('').text('Antrenör seçin'));

                            $.each(data, function (i, item) {
                                $('#AntrenorId').append(
                                    $('<option>').val(item.id).text(item.ad)
                                );
                            });
                        })
                        .fail(function () {
                            $('#AntrenorId').empty();
                            $('#AntrenorId').append($('<option>').val('').text('Antrenör yüklenemedi'));
                        });
                } else {
                    $('#AntrenorId').empty();
                    $('#AntrenorId').append($('<option>').val('').text('Önce hizmet seçin'));
                }
            });

            // ANTRENÖR + TARİHE GÖRE SAAT GETİR
            function SaatleriYukle() {
                var antrenorId = $('#AntrenorId').val();
                var tarih = $('#seciliTarih').val();

                $('#seciliSaat').empty();

                if (antrenorId && tarih) {
                    $.getJSON('@Url.Action("GetAvailableHours", "Randevu")',
                        { antrenorId: antrenorId, tarih: tarih })
                        .done(function (data) {
                            if (!data || data.length === 0) {
                                $('#seciliSaat').append(
                                    $('<option>').val('').text('Bu gün için uygun saat bulunamadı')
                                );
                            } else {
                                $('#seciliSaat').append(
                                    $('<option>').val('').text('Saat seçin')
                                );
                                $.each(data, function (i, saat) {
                                    $('#seciliSaat').append(
                                        $('<option>').val(saat).text(saat)
                                    );
                                });
                            }
                        })
                        .fail(function () {
                            $('#seciliSaat').append(
                                $('<option>').val('').text('Saatler yüklenemedi')
                            );
                        });
                } else {
                    $('#seciliSaat').append(
                        $('<option>').val('').text('Önce tarih ve antrenör seçin')
                    );
                }
            }

            $('#AntrenorId').change(SaatleriYukle);
            $('#seciliTarih').change(SaatleriYukle);
        });
    </script>
}
